{%- import "src/_mapping.json.j2" as map with context -%}

{# --- Final FAIRsharing-compatible JSON output --- #}
{%- set fairsharing_record = {} -%}

{%- set metadata = {
    "name": map.GeneralMap["Title"] if "Title" in map.GeneralMap else "",
    "abbreviation": map.GeneralMap["Abbreviation"] if "Abbreviation" in map.GeneralMap else "",
    "description": map.GeneralMap["Description"] if "Description" in map.GeneralMap else "",
    "homepage": "https://fairsharing.org",
    "contacts": [],
    "associated_tools":[]
} -%}

{# Tool #}
{%- for key, val in map.GeneralMap.valuesToolMap.items() -%}
  {%- do metadata.associated_tools.append({
    "name": val["name"],
    "url": val["url"]
  }) -%}
{%- endfor -%}

{# Person #}
{%- for key, val in map.GeneralMap.valuesPersonMap.items() -%}
  {%- do metadata.contacts.append({
    "contact_name": val["person_orcid_name"],
    "contact_orcid": val["person_orcid_code"],
    "contact_email": val["person_email"]
  }) -%}
{%- endfor -%}

{# Metric and FAIR principles #}
{%- set record_associations_attributes = [] -%}
{%- for key, val in map.GeneralMap.valuesMetricMap.items() -%}
  {%- if val["metric_id"] -%}
    {%- do record_associations_attributes.append({
      "linked_record_id": val["metric_id"],
      "record_assoc_label_id": 14
    }) -%}
  {%- endif -%}
{%- endfor -%}

{%- for item in map.GeneralMap.valuesFAIRPrinciples -%}
  {%- if item.id -%}
    {%- do record_associations_attributes.append({
      "linked_record_id": item.id,
      "record_assoc_label_id": 13
    }) -%}
  {%- endif -%}
{%- endfor -%}

{#Organisation#}
{%- set organisation_links_attributes = [] -%}

{%- if "id" in map.GeneralMap.valuesOrganisationMap -%}
  {%- do organisation_links_attributes.append({
      "relation": 'maintains',
      "is_lead": true,
      "organisation_id":map.GeneralMap.valuesOrganisationMap.id}) -%}

{% elif "url" in map.GeneralMap.valuesOrganisationMap and "id" not in map.GeneralMap.valuesOrganisationMap%}
  {%- do organisation_links_attributes.append({
      "relation": 'maintains',
      "is_lead": true,
      "organisation_attributes":{
                "organisation_type_ids": map.GeneralMap.valuesOrganisationMap.organisation_type_ids | default([]),
                "name": map.GeneralMap.valuesOrganisationMap.label | default(""),
                "homepage": map.GeneralMap.valuesOrganisationMap.homepage | default(""),
                "country_ids": map.GeneralMap.valuesOrganisationMap.country_ids | default([]),
                "ror_link": map.GeneralMap.valuesOrganisationMap.url | default("") }}) -%}

{% endif %}

{# Area of Knowledge - Subject #}
{%- set subject_ids = [] -%}
{%- for key, val in map.GeneralMap.valuesThemeMap.items() -%}
  {%- do subject_ids.append(val["id"] | int) -%}
{%- endfor -%}

{# Keyword - Domain #}
{%- set domain_ids = [] -%}
{%- for key, val in map.GeneralMap.valuesKeywordMap.items() -%}
  {%- do domain_ids.append(val["id"] | int) -%}
{%- endfor -%}

{#Digital Object type #}
{%- set digital_objects_ids = [] -%}
{%- for item in map.GeneralMap.valuesDigitalObject -%}
  {%- if item.id is defined -%}
    {%- do digital_objects_ids.append(item.id) -%}
  {%- endif -%}
{%- endfor -%}

{%- set fairsharing_record = {
  "fairsharing_record": {
    "metadata": metadata,
    "record_type_id": map.GeneralMap.valuesTagMap.id,
    "subject_ids": subject_ids,
    "domain_ids": domain_ids,
    "record_associations_attributes":record_associations_attributes,
    "object_type_ids": digital_objects_ids,
    "organisation_links_attributes": organisation_links_attributes
  }
} -%}

{#{{ map.GeneralMap | default({}) |tojson(4) }}#}

{{ fairsharing_record | default({}) |tojson(4) }}